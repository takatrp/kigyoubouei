<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>標準保障額・保険料売上換算ツール</title>

  <link rel="icon" href="favicon.ico" sizes="any" />
  <link rel="shortcut icon" href="favicon.ico" />
  <link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png" />
  <link rel="apple-touch-icon" href="favicon192192.png" />
  <meta name="theme-color" content="#578899" />

  <style>
    :root{
      --bg:#f4f9fb; --card:#ffffff; --ink:#2b3a3d; --muted:#5a6a6d;
      --accent:#578899; --accent-2:#7aa2b0; --shadow:0 10px 30px rgba(35,80,90,.12); --radius:16px;
      --border:#d9eaed; --blue:#1a6ea0;
      --success:#4caf50; --danger:#e57373;
    }
    html,body{height:100%;}
    body{margin:0; font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Yu Gothic UI","YuGothic","Noto Sans JP","Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--ink); -webkit-font-smoothing:antialiased;}
    .wrap{padding:max(12px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
            calc(16px + env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left)); max-width:820px; margin:0 auto;}

    header{padding:8px 6px 2px;}
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{height:48px; width:auto; object-fit:contain;}
    .logo-link{display:inline-flex; align-items:center; line-height:0;}
    .title{flex:1; min-width:0; font-weight:800; letter-spacing:.02em; line-height:1.2; margin:0;
      white-space:nowrap; font-size:clamp(16px, 4.6vw, 24px);}
    .subtitle{color:var(--muted); font-size:12px; margin:6px 0 0 0;}

    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:18px 16px; margin:12px 0 18px; break-inside:avoid; transition: opacity 0.3s ease, transform 0.3s ease;}
    .card h2{margin:0 0 10px; font-size:18px; font-weight:900; color:#324245; letter-spacing:.01em;}
    .label{font-size:15px; color:var(--muted); margin:0 0 6px 2px;}

    /* flex: 1; と min-width: 0; を追加して入力枠が横に広がるように調整 */
    .yen-input,.pctbox{display:flex; align-items:center; gap:8px; background:#f8fcfd; border:1px solid var(--border);
      border-radius:12px; padding:6px 8px; flex: 1; min-width: 0;}
    .pctbox{ flex: none; } /* pctbox は広げない */
    
    .yen-input.compact{padding:4px 8px;}
    .yen-input .prefix{font-weight:700; color:var(--accent); border-right:1px solid #e6f1f3; padding-right:8px;}
    input.money,input.pct{border:0; outline:none; background:transparent; font-size:18px; font-weight:800; color:var(--ink);
      letter-spacing:.02em; text-align:right; font-feature-settings:"tnum"; font-variant-numeric:tabular-nums;}
    input.money{flex:1; width:100%;}
    input::placeholder{color:#8fa2a6; opacity:.30; font-weight:600;}

    .inline-actions{display:flex; align-items:center; gap:8px; flex-wrap:nowrap;}
    .inline-actions.wrap{flex-wrap:wrap; align-items:flex-start;}
    #cmr{flex:1 1 auto; min-width:0; width:100%; height:24px; -webkit-appearance:none; background:transparent;}
    #cmr::-webkit-slider-runnable-track{height:6px; background:linear-gradient(90deg,var(--accent-2),var(--accent)); border-radius:999px;}
    #cmr::-webkit-slider-thumb{-webkit-appearance:none; width:20px; height:20px; border-radius:50%; background:#fff; border:2px solid var(--accent); margin-top:-7px; box-shadow:0 1px 6px rgba(0,0,0,.08);}
    .pctbox input.pct{width:72px; font-size:18px;}

    /* カラム比率を 1:1 から 1.7:1 に変更 */
    .row-two{display:grid; grid-template-columns:1.7fr 1fr; gap:12px; align-items:end;}
    @media (max-width:680px){ .row-two{grid-template-columns:1fr;} }

    .helper-btn{
      border:1px solid var(--border); background:#eef7f8; color:#2a6b7b;
      padding:6px 10px; border-radius:10px; font-size:13px; font-weight:800;
      cursor:pointer; white-space:nowrap;
    }
    @media (max-width:420px){
      .helper-btn{font-size:12px; padding:5px 8px;}
      .inline-actions{gap:6px;}
    }

    .btn{width:100%; background:linear-gradient(180deg,var(--accent-2),var(--accent)); color:#fff; font-weight:900;
      border:0; border-radius:12px; padding:10px 12px; font-size:15px; cursor:pointer;}
    .btn:active{transform:translateY(1px);}

    .chip-row{display:flex; gap:8px; flex-wrap:wrap;}
    .chip{
      border:1px solid #e6f3f7; background:#f7fbfd; color:#7aa2b0;
      padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900; cursor:pointer; user-select:none;
      transition:background-color .15s, color .15s, border-color .15s;
    }
    .chip:hover{background:#eef7fa;}
    .chip.active{background:#cfe7ef; border-color:#9ecbd9; color:#0f4f63;}

    .result{margin-top:12px;}
    .amount{text-align:center; font-size:clamp(22px,7vw,34px); font-weight:900; color:#2a6b7b; margin:4px 0 6px; font-feature-settings:"tnum"; font-variant-numeric:tabular-nums;}
    .statement{text-align:center; font-weight:900; color:var(--ink); margin:6px 0 2px; line-height:1.6;}
    .blue{color:#1a6ea0;} .up1{font-size:1.1em;}
    .note-line{color:inherit;}

    /* チップを中央揃えにするための調整 */
    .kpi{display:flex; align-items:center; flex-wrap:wrap; gap:10px; justify-content:center; position:relative;}
    .chip-like{background:#e9f6f8; border:1px dashed #8fb3c0; border-radius:12px; padding:8px 10px; font-weight:900;}
    .formula-chip{position:absolute; right:0; top:50%; transform:translateY(-50%); margin-left:0; font-size:12px; color:#6a7a7d; border:0; background:transparent; padding:0;}

    /* 狭い画面では計算式を下に逃がす */
    @media (max-width:800px){
      .formula-chip{position:static; transform:none; width:100%; text-align:right; margin-top:4px;}
    }

    .transition-card {
      background: #eef7f9;
      border: 2px solid #cfe3ea;
      text-align: center;
      padding: 20px 16px;
    }
    .transition-title {
      font-size: 16px; font-weight: 900; color: #1a6ea0; margin-bottom: 16px;
      line-height: 1.5;
    }
    .choice-row {
      display: flex; gap: 12px; justify-content: center;
    }
    .choice-btn {
      flex: 1; max-width: 200px;
      padding: 12px; border-radius: 12px; border: 0;
      font-weight: 900; font-size: 15px; cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      transition: transform 0.1s;
    }
    .choice-btn:active { transform: scale(0.98); }

    .btn-yes { background: #fff; color: var(--accent); border: 2px solid var(--accent); }
    .btn-no  { background: linear-gradient(135deg, #7aa2b0, #4a7c8c); color: #fff; }

    .msg-box {
      margin-top: 16px; padding: 12px; border-radius: 10px; font-weight: bold; text-align: left;
      font-size: 14px; line-height: 1.6; animation: fadeIn 0.4s ease;
    }
    .msg-success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    .msg-guide   { background: #fff; color: var(--ink); border: 1px dashed var(--accent); }

    .reconsider-btn {
      background: transparent; border: 1px solid #a5d6a7; color: #2e7d32;
      border-radius: 6px; padding: 4px 10px; font-size: 13px; cursor: pointer;
      font-weight: bold; display: inline-block;
    }
    .reconsider-btn:hover { background: #c8e6c9; }

    @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

    .card-actions{padding-top:10px;}
    .action-row{display:flex; gap:10px; margin:6px 0; flex-wrap:nowrap;}
    .action-row .btn{
      background:#eef7f9; color:#3f7c8e; border:1px solid #cfe3ea; box-shadow:none;
      padding:12px 14px; font-size:15px; border-radius:12px; flex:1 1 33%; white-space:nowrap;
    }
    .action-row .btn:hover{background:#e6f2f6;}

    /* ====== Accessibility helper ====== */
    .sr-only{
      position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* ====== 打ち手検討CTA（アクセント統一） ====== */
    .cta-wrap{ margin-top: 14px; }
    .cta-accent{
      width:100%;
      border:0;
      cursor:pointer;
      padding:14px 14px;
      border-radius:18px;
      font-weight:900;
      font-size:17px;
      letter-spacing:.02em;
      color:#fff;
      background: linear-gradient(180deg,var(--accent-2),var(--accent));
      box-shadow: 0 10px 22px rgba(35,80,90,.16);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .cta-accent:active{ transform: translateY(1px); }
    .cta-accent .arrow{ font-size: 20px; line-height: 1; }

    /* 印刷時の設定 */
    @page { size: auto; margin: 12mm; }
    @media print{
      body{background:#fff;}
      .card{box-shadow:none;}
      .transition-card{ display:none !important; }
      .card-actions{ display:none !important; }
      .cta-wrap{ display:none !important; } /* CTAは印刷不要 */

      /* 結果が無いセクションは印刷しない（E） */
      #covSection:not(.has-result){ display:none !important; }
      #premSection:not(.has-result){ display:none !important; }
    }

    [hidden] { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <a class="logo-link" href="https://takatrp.github.io/tool-portal/" title="ツールポータルへ">
          <img src="ロゴ.jpg" alt="松本会計事務所ロゴ" class="logo" />
        </a>
        <h1 class="title">標準保障額・保険料売上換算ツール</h1>
      </div>
      <div class="subtitle">標準保障額／必要保険料と限界利益率から、売上相当額・売上比率・必要販売数を算出します。</div>
    </header>

    <section class="card" id="covSection" aria-label="標準保障額の換算">
      <h2>標準保障額の換算</h2>

      <div class="row-two">
        <div>
          <div class="label">標準保障額（円）</div>
          <div class="inline-actions">
            <div class="yen-input compact">
              <span class="prefix">¥</span>
              <input id="cov" class="money" type="text" inputmode="numeric" placeholder="例：100,000,000" autocomplete="off" />
            </div>
            <button class="helper-btn" id="openCovInfo" type="button">標準保障額とは</button>
          </div>
        </div>
        <div>
          <div class="label">御社の限界利益率（％）</div>
          <div class="inline-actions">
            <input id="cmr" type="range" min="5" max="95" step="0.1" value="43.6" />
            <div class="pctbox"><input id="cmrInput" class="pct" type="text" inputmode="decimal" value="43.6" /><span class="unit">%</span></div>
          </div>
        </div>
      </div>

      <div class="row-two" style="margin-top:10px;">
        <div>
          <div class="label">売上（円）</div>
          <div class="inline-actions">
            <div class="yen-input">
              <span class="prefix">¥</span>
              <input id="sales" class="money" type="text" inputmode="numeric" placeholder="例：120,000,000" autocomplete="off" />
            </div>
            <div class="chip-row" role="tablist" aria-label="売上の期間">
              <button class="chip" id="salesMonthly" type="button">月額</button>
              <button class="chip active" id="salesYearly" type="button">年額</button>
            </div>
          </div>
        </div>
        <div>
          <div class="label">平均単価（円）</div>
          <div class="yen-input">
            <span class="prefix">¥</span>
            <input id="avgPrice" class="money" type="text" inputmode="numeric" placeholder="例：10,000" autocomplete="off" />
          </div>
        </div>
      </div>

      <button id="calcCov" class="btn" type="button" style="margin-top:12px;">売上に換算</button>

      <div class="result" id="resCov" hidden>
        <div class="amount" id="salesCov" data-value="0"></div>
        <div class="statement" id="stmtCov"></div>
        <div class="kpi">
          <span class="chip-like" id="pctAnnualCov" hidden>年間売上の — %</span>
          <span class="chip-like" id="unitsCovChip" hidden>必要販売数：—</span>
          <span class="formula-chip">計算式：標準保障額 ÷ (限界利益率 / 100)</span>
        </div>
      </div>
    </section>

    <section class="card transition-card" id="transitionArea" hidden>
      <div class="transition-title" id="transitionTitle"></div>
      <div class="choice-row" id="choiceBtns">
        <button class="choice-btn btn-yes" id="btnCanAchieve" type="button">はい、確保できます</button>
        <button class="choice-btn btn-no" id="btnCannotAchieve" type="button">いいえ、難しいです</button>
      </div>

      <div class="msg-box msg-success" id="msgSuccess" hidden>
        素晴らしいです。<br>
        自社の財務体力でリスクをカバーできる状態ですので、無理に保険を検討する必要はないかもしれません。<br>
        <div style="text-align:right; margin-top:8px;">
          <button id="btnReconsider" type="button" class="reconsider-btn">やはり難しいかも &gt;</button>
        </div>
      </div>
      <div class="msg-box msg-guide" id="msgGuide" hidden></div>
    </section>

    <section class="card" id="premSection" aria-label="必要保険料の換算" hidden>
      <h2>必要保険料の換算</h2>

      <div class="row-two">
        <div>
          <div class="label">必要保険料（円）</div>
          <div class="inline-actions">
            <div class="yen-input compact">
              <span class="prefix">¥</span>
              <input id="prem" class="money" type="text" inputmode="numeric" placeholder="例：12,000" autocomplete="off" />
            </div>

            <div class="chip-row" role="tablist" aria-label="支出のタイプ">
              <button class="chip active" id="premMonthly" type="button">月額</button>
              <button class="chip" id="premYearly" type="button">年額</button>
            </div>
          </div>
        </div>
        <div></div>
      </div>

      <button id="calcPrem" class="btn" type="button" style="margin-top:12px;">売上に換算</button>

      <div class="result" id="resPrem" hidden>
        <div class="amount" id="salesPrem"
             data-total="0" data-monthly="0" data-annual="0" data-mode="month"></div>
        <div class="statement" id="stmtPrem"></div>
        <div class="kpi">
          <span class="chip-like" id="pctSalesPrem" hidden>—</span>
          <span class="chip-like" id="unitsPremChip" hidden>必要販売数：—</span>
          <span class="formula-chip" id="formulaPrem">計算式：必要保険料 ÷ (限界利益率 / 100)</span>
        </div>

        <div class="cta-wrap" id="tacticsArea" hidden>
          <button id="openTactics" class="cta-accent" type="button">
            売上を追加で上げるための「打ち手」を検討する <span class="arrow">→</span>
          </button>
        </div>
      </div>
    </section>

    <section class="card card-actions" aria-label="操作">
      <div class="action-row">
        <button id="copy" class="btn" type="button">コピー</button>
        <button id="reset" class="btn" type="button">リセット</button>
        <button id="print" class="btn" type="button">印刷 / PDF保存</button>
      </div>
    </section>

    <footer class="mk-mini">
      © <span id="cpy-year">2025</span> <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener license">税理士法人松本会計事務所</a> ｜ 
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="license noopener">CC BY-NC-SA 4.0</a> ｜ 
      <a href="/tool-portal/terms.html" target="_blank" rel="noopener">利用条件</a> ｜ 
      <span id="build-rev">r29</span>（<span id="last-updated-date"></span>）
    </footer>
  </div>

  <dialog id="covInfoDlg" aria-labelledby="covInfoTitle" aria-describedby="covInfoDesc" aria-modal="true" role="dialog">
    <p id="covInfoDesc" class="sr-only">
      標準保障額の考え方を図解で説明します。閉じるボタンでモーダルを閉じます。
    </p>
    <div class="dlg-body">
      <div class="dlg-head">
        <h3 id="covInfoTitle">標準保障額とは</h3>
        <button class="dlg-close" id="closeCovInfo" type="button" aria-label="閉じる">×</button>
      </div>
      <img src="標準保障額.png" alt="標準保障額とは（図解）" class="dlg-img" />
    </div>
  </dialog>

  <script>
    const $ = s => document.querySelector(s);
    const fmtJPY = n => n.toLocaleString('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0});
    const fmt1 = n => n.toLocaleString('ja-JP',{minimumFractionDigits:1, maximumFractionDigits:1});
    const parsePct = t => { if(t==null) return NaN; const s=String(t).replace('%','').replace(',', '.').trim(); return Number(s); };

    /* ★確定：打ち手検討ツールURL */
    const TACTICS_URL = 'https://takatrp.github.io/sale-kit/';

    // 年号 & 最終更新日
    const yEl = $('#cpy-year'), dEl = $('#last-updated-date');
    const now = new Date();
    if (yEl) yEl.textContent = String(now.getFullYear());
    if (dEl) {
      const lm = new Date(document.lastModified);
      const pad = n => String(n).padStart(2,'0');
      dEl.textContent = `${lm.getFullYear()}-${pad(lm.getMonth()+1)}-${pad(lm.getDate())}`;
    }

    // 要素
    const covEl=$('#cov'), cmrR=$('#cmr'), cmrI=$('#cmrInput');
    const salesEl=$('#sales'), salesMonthly=$('#salesMonthly'), salesYearly=$('#salesYearly'), avgEl=$('#avgPrice');

    const premEl=$('#prem');
    const premMonthly=$('#premMonthly'), premYearly=$('#premYearly');

    const covSection=$('#covSection');
    const premSection=$('#premSection');

    const resCov=$('#resCov'), salesCovEl=$('#salesCov'), stmtCov=$('#stmtCov');
    const pctAnnualCov=$('#pctAnnualCov'), unitsCovChip=$('#unitsCovChip');

    const transitionArea=$('#transitionArea'), transitionTitle=$('#transitionTitle'), choiceBtns=$('#choiceBtns');
    const btnCanAchieve=$('#btnCanAchieve'), btnCannotAchieve=$('#btnCannotAchieve');
    const msgSuccess=$('#msgSuccess'), msgGuide=$('#msgGuide'), btnReconsider=$('#btnReconsider');

    const resPrem=$('#resPrem'), salesPremEl=$('#salesPrem'), stmtPrem=$('#stmtPrem');
    const pctSalesPrem=$('#pctSalesPrem'), unitsPremChip=$('#unitsPremChip');
    const formulaPrem = $('#formulaPrem');

    // ★打ち手検討CTA
    const tacticsArea = $('#tacticsArea');
    const openTacticsBtn = $('#openTactics');

    function setHasResult(sectionEl, has){
      if(!sectionEl) return;
      sectionEl.classList.toggle('has-result', !!has);
    }

    function setCmr(v){ cmrR.value=Number(v).toFixed(1); cmrI.value=Number(v).toFixed(1); }
    setCmr(43.6);

    cmrR.addEventListener('input', ()=>{ cmrI.value=(+cmrR.value).toFixed(1); if(autoAny()) autoRecalc(); });
    cmrI.addEventListener('input', ()=>{ 
      let v=parsePct(cmrI.value); 
      if(!isNaN(v)) {
        if(v > 100) { v = 100; cmrI.value = '100'; }
        cmrR.value=v.toFixed(1); 
      }
      if(autoAny()) autoRecalc(); 
    });

    function normalizeDigits(str){
      if(!str) return '';
      str=str.replace(/[０-９]/g,s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0));
      const map={'⓪':'0','①':'1','②':'2','③':'3','④':'4','⑤':'5','⑥':'6','⑦':'7','⑧':'8','⑨':'9'};
      str=str.replace(/[⓪①②③④⑤⑥⑦⑧⑨]/g,s=>map[s]||s);
      return str.replace(/[^\d]/g,'');
    }
    function attachMoneyFormatter(input,onChange){
      input.addEventListener('input',e=>{
        const raw=normalizeDigits(e.target.value);
        e.target.value=raw?Number(raw).toLocaleString('ja-JP'):'';
        onChange?.();
      });
      input.addEventListener('focus',e=>{
        const d=e.target.value.replace(/[^\d]/g,'');
        if(d) e.target.value=String(Number(d));
      });
      input.addEventListener('blur', e=>{
        const d=e.target.value.replace(/[^\d]/g,'');
        e.target.value=d?Number(d).toLocaleString('ja-JP'):'';
      });
    }

    const parseMoney = s => { if(!s) return NaN; const d=String(s).replace(/[^\d]/g,''); return d?Number(d):NaN; };

    attachMoneyFormatter(covEl,  ()=>{ if(autoCov)  calcCoverage(false,false); });
    attachMoneyFormatter(premEl, ()=>{ if(autoPrem) calcPremium(false,false); else hideTacticsCTA(); });
    attachMoneyFormatter(salesEl,()=>{ if(!resCov.hidden||!resPrem.hidden) updateOptionalMetrics(); });
    attachMoneyFormatter(avgEl,  ()=>{ if(!resCov.hidden||!resPrem.hidden) updateOptionalMetrics(); });

    function activateChip(on,off){
      on.classList.add('active'); on.setAttribute('aria-selected','true');
      off.classList.remove('active'); off.setAttribute('aria-selected','false');
    }

    function getPremMode(){
      if(premYearly.classList.contains('active')) return 'year';
      return 'month';
    }

    function updatePlaceholders(){
      salesEl.placeholder = salesYearly.classList.contains('active') ? '例：120,000,000' : '例：10,000,000';
      const mode = getPremMode();
      premEl.placeholder = (mode==='year') ? '例：144,000' : '例：12,000';
    }

    salesMonthly.addEventListener('click', ()=>{
      activateChip(salesMonthly,salesYearly); updatePlaceholders();
      if(!resCov.hidden||!resPrem.hidden) updateOptionalMetrics();
    });
    salesYearly .addEventListener('click', ()=>{
      activateChip(salesYearly ,salesMonthly); updatePlaceholders();
      if(!resCov.hidden||!resPrem.hidden) updateOptionalMetrics();
    });

    // 支出タイプ切替（月額 / 年額）
    function setPremMode(mode){
      if(mode==='month') activateChip(premMonthly, premYearly);
      if(mode==='year')  activateChip(premYearly,  premMonthly);

      hideTacticsCTA();
      updatePlaceholders();

      if(autoPrem) calcPremium(false,false);
      else if(!resCov.hidden||!resPrem.hidden) updateOptionalMetrics();
    }

    premMonthly.addEventListener('click', ()=> setPremMode('month'));
    premYearly .addEventListener('click', ()=> setPremMode('year'));

    updatePlaceholders();

    let autoCov=false, autoPrem=false;
    const autoAny = ()=> autoCov || autoPrem;
    function autoRecalc(){
      if(autoCov)  calcCoverage(false,false);
      if(autoPrem) calcPremium(false,false);
    }

    function updateOptionalMetrics(){
      const avg = parseMoney(avgEl.value);
      const salesVal = parseMoney(salesEl.value);
      const salesPeriod = salesYearly.classList.contains('active') ? 'year' : 'month';

      // --- coverage ---
      if(!resCov.hidden && salesCovEl.textContent){
        const covVal = Number(salesCovEl.dataset.value || 0);
        if(salesVal>0){
          const annualSales = (salesPeriod==='year') ? salesVal : salesVal*12;
          const pct = annualSales>0 ? (covVal/annualSales)*100 : NaN;
          pctAnnualCov.textContent = `年間売上の ${pct.toFixed(1)}%`;
          pctAnnualCov.hidden = isNaN(pct);
        }else{ pctAnnualCov.hidden = true; }

        if(avg>0){
          unitsCovChip.textContent = `必要販売数：${fmt1(covVal/avg)}`;
          unitsCovChip.hidden = false;
        }else{ unitsCovChip.hidden = true; }
      }

      // --- premium (月額 / 年額) ---
      if(!resPrem.hidden && salesPremEl.textContent){
        const mode = salesPremEl.dataset.mode || 'month';
        const monthlyNeeded = Number(salesPremEl.dataset.monthly || 0);
        const annualNeeded  = Number(salesPremEl.dataset.annual  || 0);

        if(salesVal>0){
          const monthlyBase = (salesPeriod==='month') ? salesVal : (salesVal/12);
          const annualBase  = (salesPeriod==='year')  ? salesVal : (salesVal*12);

          let pct = NaN, label = '';
          if(mode==='month'){
            pct = (monthlyBase>0) ? (monthlyNeeded/monthlyBase)*100 : NaN;
            label = `月間売上の ${pct.toFixed(1)}%`;
          }else{
            pct = (annualBase>0) ? (annualNeeded/annualBase)*100 : NaN;
            label = `年間売上の ${pct.toFixed(1)}%`;
          }

          pctSalesPrem.textContent = label;
          pctSalesPrem.hidden = isNaN(pct);
        }else{
          pctSalesPrem.hidden = true;
        }

        if(avg>0){
          if(mode==='year'){
            unitsPremChip.textContent = `必要販売数（年）：${fmt1(annualNeeded/avg)}`;
          }else{
            unitsPremChip.textContent = `必要販売数（月）：${fmt1(monthlyNeeded/avg)}`;
          }
          unitsPremChip.hidden = false;
        }else{
          unitsPremChip.hidden = true;
        }
      }
    }

    function hideTacticsCTA(){ if(tacticsArea) tacticsArea.hidden = true; }
    function showTacticsCTA(){ if(tacticsArea) tacticsArea.hidden = false; }

    function calcCoverage(scroll=true, manual=true){
      const rate = parsePct(cmrI.value)/100;
      const cov  = parseMoney(covEl.value);

      if(!(rate>0) || !(cov>0)){
        if(manual){
          if(!(rate>0)){ alert('限界利益率を正しく入力してください。'); cmrI.focus(); }
          else { alert('標準保障額を入力してください。'); covEl.focus(); }
        }
        resCov.hidden = true;
        transitionArea.hidden = true;
        premSection.hidden = true;
        resPrem.hidden = true;
        hideTacticsCTA();

        setHasResult(covSection,false);
        setHasResult(premSection,false);

        pctAnnualCov.hidden=true; unitsCovChip.hidden=true;
        pctSalesPrem.hidden=true; unitsPremChip.hidden=true;
        return;
      }

      const salesNeededCov = Math.ceil(cov / rate);
      resCov.hidden=false;
      salesCovEl.dataset.value = salesNeededCov;
      salesCovEl.textContent = fmtJPY(salesNeededCov);

      const covFmt = fmtJPY(cov);
      const salesFmt = fmtJPY(salesNeededCov);

      stmtCov.innerHTML =
        `標準保障額 ${covFmt} は、御社の売上 ${salesFmt} に相当します。<br>`+
        `<span class="note-line">標準保障額は、保険事故発生後に短期間で必要と想定される金額です。</span><br>`+
        `<span class="blue up1">もし万が一の際、被保険者が不在の中、この売上を上げることはできますか？</span>`;

      updateOptionalMetrics();
      autoCov=true;

      transitionTitle.innerHTML =
        `経営者の不在時など、万が一の際に<br>この <span class="blue">${covFmt}の資金</span> または <span class="blue">${salesFmt}の売上</span> を、即座に確保することは可能ですか？<br>` +
        `<span style="font-weight:normal; color:var(--ink); font-size:0.95em;">難しければ、企業の存続や遺族の生活に影響を及ぼします。</span>`;

      msgGuide.innerHTML =
        `緊急時に ${covFmt} の資金の確保または ${salesFmt} の売上の確保が難しい場合、その分を「保険」で補う必要があります。<br>`+
        `では、<strong>「その保障を持つためのコスト（保険料）」</strong>が、売上換算でいくらに相当するか確認してみましょう。`;

      transitionArea.hidden = false;
      choiceBtns.hidden = false;
      msgSuccess.hidden = true;
      msgGuide.hidden = true;

      setHasResult(covSection,true);

      if(scroll) transitionArea.scrollIntoView({behavior:'smooth', block:'center'});
    }

    btnCanAchieve.addEventListener('click', ()=>{
      choiceBtns.hidden = true;
      msgSuccess.hidden = false;
      msgGuide.hidden = true;
      premSection.hidden = true;
      resPrem.hidden = true;
      hideTacticsCTA();
      setHasResult(premSection,false);
    });

    btnCannotAchieve.addEventListener('click', ()=>{ showPremiumSection(); });
    btnReconsider.addEventListener('click', ()=>{ showPremiumSection(); });

    function showPremiumSection(){
      choiceBtns.hidden = true;
      msgSuccess.hidden = true;
      msgGuide.hidden = false;
      premSection.hidden = false;
      premSection.scrollIntoView({behavior:'smooth', block:'start'});
    }

    // 必要保険料（月額 / 年額）
    function calcPremium(scroll=true, manual=true){
      const rate = parsePct(cmrI.value)/100;
      const prem = parseMoney(premEl.value);
      const mode = getPremMode(); // month / year

      if(!(rate>0) || !(prem>0)){
        if(manual){
          if(!(rate>0)){ alert('限界利益率を正しく入力してください。'); cmrI.focus(); }
          else { alert('必要保険料を入力してください。'); premEl.focus(); }
        }
        resPrem.hidden = true;
        hideTacticsCTA();
        setHasResult(premSection,false);
        pctSalesPrem.hidden=true; unitsPremChip.hidden=true;
        return;
      }

      // 総必要売上（支出÷CMR）
      const totalNeeded = Math.ceil(prem / rate);

      let monthlyNeeded = 0;
      let annualNeeded  = 0;

      if(mode==='month'){
        monthlyNeeded = totalNeeded;
        annualNeeded  = totalNeeded * 12;

        salesPremEl.textContent = `${fmtJPY(monthlyNeeded)} / 月`;
        stmtPrem.innerHTML =
          `必要保険料 ${fmtJPY(prem)} は、御社の月間売上 ${fmtJPY(monthlyNeeded)} に相当します。<br>` +
          `<span class="blue up1">月${fmtJPY(monthlyNeeded)}の売上を追加で上げれば、必要な保険料をカバーし、将来の不安を解消できます。</span>`;

        formulaPrem.textContent = '計算式：必要保険料 ÷ (限界利益率 / 100)';
      }else{
        annualNeeded  = totalNeeded;
        monthlyNeeded = Math.round(annualNeeded / 12);

        salesPremEl.innerHTML = `${fmtJPY(annualNeeded)} / 年 <span style="font-size:0.75em; color:var(--muted); margin-left:4px;">（${fmtJPY(monthlyNeeded)} / 月）</span>`;
        stmtPrem.innerHTML =
          `必要保険料 ${fmtJPY(prem)} は、御社の年間売上 ${fmtJPY(annualNeeded)}（月${fmtJPY(monthlyNeeded)}）に相当します。<br>` +
          `<span class="blue up1">年${fmtJPY(annualNeeded)}（月${fmtJPY(monthlyNeeded)}）の売上を追加で上げれば、必要な保険料をカバーし、将来の不安を解消できます。</span>`;

        formulaPrem.textContent = '計算式：必要保険料 ÷ (限界利益率 / 100)';
      }

      // dataset（KPI用）
      salesPremEl.dataset.total = String(totalNeeded);
      salesPremEl.dataset.monthly = String(monthlyNeeded);
      salesPremEl.dataset.annual = String(annualNeeded);
      salesPremEl.dataset.mode = mode;

      resPrem.hidden=false;
      updateOptionalMetrics();
      autoPrem=true;

      setHasResult(premSection,true);
      showTacticsCTA();

      if(scroll) resPrem.scrollIntoView({behavior:'smooth', block:'center'});
    }

    $('#calcCov').addEventListener('click', ()=> calcCoverage(true,true));
    $('#calcPrem').addEventListener('click', ()=> calcPremium(true,true));

    // ★打ち手検討 起動（月額換算の支出として渡す：月額＝そのまま、年額＝÷12）
    function buildTacticsPayloadOrAlert(){
      if(resPrem.hidden){
        calcPremium(true,true);
        if(resPrem.hidden) return null;
      }

      const salesVal = parseMoney(salesEl.value);
      const avgVal   = parseMoney(avgEl.value);
      const premVal  = parseMoney(premEl.value);
      const cmrVal   = parsePct(cmrI.value);
      const mode     = getPremMode(); // month / year

      if(!(salesVal>0)){
        alert('売上を入力してください（年額／月額の切替も確認してください）。');
        salesEl.focus();
        return null;
      }
      if(!(avgVal>0)){
        alert('平均単価（取引単価）を入力してください。');
        avgEl.focus();
        return null;
      }
      if(!(premVal>0)){
        alert('必要保険料を入力してください。');
        premEl.focus();
        return null;
      }

      const annualSales = salesYearly.classList.contains('active') ? salesVal : salesVal * 12;

      let expenseMonthlyEq = 0;
      if(mode==='month'){
        expenseMonthlyEq = premVal;
      }else{
        expenseMonthlyEq = Math.round(premVal / 12);
      }

      return {
        v: 2,
        annual_sales: Math.round(annualSales),
        unit_price: Math.round(avgVal),

        expense: Math.max(0, Math.round(expenseMonthlyEq)),
        expense_period: 'month',

        raw_expense: Math.round(premVal),
        raw_period: mode, // month / year

        cmr_pct: (cmrVal>0 ? Number(cmrVal.toFixed(1)) : null),
        created_at: new Date().toISOString(),
        src: 'premium-converter-A'
      };
    }

    function openTacticsTool(){
      const payload = buildTacticsPayloadOrAlert();
      if(!payload) return;

      try{
        localStorage.setItem('mk_uchite_payload_v1', JSON.stringify(payload));
      }catch(e){ /* ignore */ }

      const qs = new URLSearchParams();
      qs.set('annual_sales', String(payload.annual_sales));
      qs.set('unit_price',   String(payload.unit_price));
      qs.set('expense',      String(payload.expense));
      qs.set('expense_period', payload.expense_period);
      if(payload.cmr_pct!=null) qs.set('cmr_pct', String(payload.cmr_pct));
      qs.set('src', payload.src);

      qs.set('raw_expense', String(payload.raw_expense));
      qs.set('raw_period', String(payload.raw_period));

      const url = TACTICS_URL + (TACTICS_URL.includes('?') ? '&' : '?') + qs.toString() + '#autofill=1';
      window.open(url, '_blank', 'noopener');
    }

    openTacticsBtn?.addEventListener('click', openTacticsTool);

    // コピー
    $('#copy').addEventListener('click', async ()=>{
      const cmrTxt = `${(+parsePct(cmrI.value)).toFixed(1)}%`;
      const lines = [];
      if(!resCov.hidden){
        lines.push(`[標準保障額] ${salesCovEl.textContent}（CMR ${cmrTxt}）`);
        lines.push(stmtCov.textContent);
      }
      if(!premSection.hidden && !resPrem.hidden){
        lines.push(`------------------`);
        lines.push(`[必要保険料] ${salesPremEl.textContent}（CMR ${cmrTxt}）`);
        lines.push(stmtPrem.textContent);
      }
      const text = lines.join('\n');
      try{
        if(navigator.clipboard?.writeText){ await navigator.clipboard.writeText(text); alert('結果をコピーしました。'); }
        else{
          const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('結果をコピーしました。');
        }
      }catch{ alert('コピーに失敗しました。'); }
    });

    // リセット
    $('#reset').addEventListener('click', ()=>{
      [covEl, salesEl, avgEl, premEl].forEach(el=> el.value='');
      activateChip(salesYearly, salesMonthly);
      setPremMode('month');
      setCmr(43.6);

      resCov.hidden=true;
      transitionArea.hidden=true;
      premSection.hidden=true;
      resPrem.hidden=true;
      hideTacticsCTA();

      pctAnnualCov.hidden=true; pctSalesPrem.hidden=true;
      unitsCovChip.hidden=true; unitsPremChip.hidden=true;

      autoCov=false; autoPrem=false;

      salesCovEl.dataset.value = "0";
      salesPremEl.dataset.total = "0";
      salesPremEl.dataset.monthly = "0";
      salesPremEl.dataset.annual = "0";
      salesPremEl.dataset.mode = "month";

      setHasResult(covSection,false);
      setHasResult(premSection,false);

      updatePlaceholders();
      window.scrollTo({top:0, behavior:'smooth'});
    });

    $('#print').addEventListener('click', ()=> window.print() );

    // (C) モーダル：フォーカス管理
    const dlg=$('#covInfoDlg');
    const openBtn=$('#openCovInfo');
    const closeBtn=$('#closeCovInfo');
    let lastFocusEl = null;

    openBtn.addEventListener('click', ()=>{
      lastFocusEl = document.activeElement;
      dlg.showModal();
      setTimeout(()=>{ closeBtn?.focus(); }, 0);
    });

    closeBtn.addEventListener('click', ()=> dlg.close());

    dlg.addEventListener('close', ()=>{
      if(lastFocusEl && typeof lastFocusEl.focus === 'function'){
        lastFocusEl.focus();
      }else{
        openBtn?.focus();
      }
      lastFocusEl = null;
    });

    dlg.addEventListener('click', e=>{ if(e.target===dlg) dlg.close(); });
  </script>
</body>
</html>
