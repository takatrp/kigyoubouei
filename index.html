<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>標準保障額・保険料売上換算ツール</title>

  <!-- Favicon（表示安定のため複数定義） -->
  <link rel="icon" type="image/png" sizes="192x192" href="favicon192192.png" />
  <link rel="icon" type="image/png" sizes="32x32"  href="favicon192192.png" />
  <link rel="icon" type="image/png" sizes="16x16"  href="favicon192192.png" />
  <link rel="apple-touch-icon" href="favicon192192.png" />
  <meta name="theme-color" content="#578899" />

  <style>
    :root{
      --bg:#f4f9fb; --card:#ffffff; --ink:#1e2a2d; --muted:#5a6a6d;
      --accent:#578899; --accent-2:#7aa2b0; --shadow:0 10px 30px rgba(35,80,90,.12); --radius:16px;
      --border:#d9eaed;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN","Yu Gothic UI","YuGothic","Noto Sans JP","Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--ink); -webkit-font-smoothing:antialiased;
    }
    .wrap{padding:max(12px, env(safe-area-inset-top)) max(14px, env(safe-area-inset-right))
           calc(16px + env(safe-area-inset-bottom)) max(14px, env(safe-area-inset-left)); max-width:820px; margin:0 auto;}

    header{padding:8px 6px 2px;}
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{height:48px; width:auto; object-fit:contain; flex:0 0 auto;}
    .title{flex:1; min-width:0; font-weight:800; letter-spacing:.02em; line-height:1.2; margin:0;
      white-space:nowrap; font-size:clamp(16px, 4.6vw, 24px);}
    @media (max-width:360px){ .title{font-size:clamp(15px, 4.2vw, 20px);} }
    .subtitle{color:var(--muted); font-size:12px; margin:6px 0 0 0;}

    .card{
      background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:18px 16px; margin:12px 0 18px; break-inside:avoid;
    }
    .card h2{margin:0 0 10px; font-size:18px; font-weight:900; color:#324245; letter-spacing:.01em;}

    .label{font-size:15px; color:var(--muted); margin:0 0 6px 2px;}

    /* 入力UI */
    .yen-input,.pctbox{
      display:flex; align-items:center; gap:8px; background:#f8fcfd; border:1px solid var(--border);
      border-radius:12px; padding:6px 8px;
    }
    .yen-input.compact{padding:4px 8px;}
    .yen-input .prefix{font-weight:700; color:var(--accent); border-right:1px solid #e6f1f3; padding-right:8px;}
    input.money,input.pct{
      border:0; outline:none; background:transparent; font-size:18px; font-weight:800; color:var(--ink);
      letter-spacing:.02em; width:170px; text-align:right; font-feature-settings:"tnum"; font-variant-numeric:tabular-nums;
    }
    /* 薄いプレースホルダ（さらに薄く） */
    input::placeholder{color:#8fa2a6; opacity:.32; font-weight:600;}

    /* CMR（同一行・スライダー長く／入力欄小さく） */
    .inline-actions{display:flex; align-items:center; gap:8px;}
    .inline-actions.nowrap{flex-wrap:nowrap;}
    #cmr{flex:1 1 auto; min-width:260px; width:100%; height:24px; -webkit-appearance:none; background:transparent;}
    #cmr::-webkit-slider-runnable-track{height:6px; background:linear-gradient(90deg,var(--accent-2),var(--accent)); border-radius:999px;}
    #cmr::-webkit-slider-thumb{-webkit-appearance:none; width:20px; height:20px; border-radius:50%; background:#fff; border:2px solid var(--accent); margin-top:-7px; box-shadow:0 1px 6px rgba(0,0,0,.08);}
    .pctbox input.pct{width:88px; font-size:18px;} /* ← 入力欄を小さく */

    .row-two{display:grid; grid-template-columns:1fr 1fr; gap:12px; align-items:end;}
    @media (max-width:680px){ .row-two{grid-template-columns:1fr;} }

    .helper-btn{border:1px solid var(--border); background:#eef7f8; color:#2a6b7b; padding:6px 10px;
      border-radius:10px; font-size:13px; font-weight:800; cursor:pointer;}

    /* ボタン（背低く＆ワイド） */
    .btn{
      width:100%; background:linear-gradient(180deg,var(--accent-2),var(--accent)); color:#fff; font-weight:900;
      border:0; border-radius:12px; padding:10px 12px; font-size:15px;
    }
    .btn:active{transform:translateY(1px);}

    /* 期間チップ */
    .chip-row{display:flex; gap:8px; flex-wrap:wrap;}
    .chip{
      border:1px solid var(--border); background:#f3fafb; color:#1f3a3e; padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:900; cursor:pointer; user-select:none;
    }
    .chip.active{background:#e0f1f5; border-color:#bcdde4; color:#0f2022;}

    .result{margin-top:12px;}
    .amount{font-size:clamp(22px,7vw,34px); font-weight:900; color:#2a6b7b; margin:4px 0 6px; font-feature-settings:"tnum"; font-variant-numeric:tabular-nums;}
    .statement{font-weight:900; color:#2b3a3d; margin:6px 0 2px; line-height:1.6;}
    .kpi{display:flex; flex-wrap:wrap; gap:10px; align-items:center; color:#2b3a3d; margin-top:6px;}
    .kpi .chip-like{background:#e9f6f8; border:1px dashed #8fb3c0; border-radius:12px; padding:8px 10px; font-weight:900;}

    /* 3ボタン：目立つスタイル */
    .action-row{display:flex; gap:10px; margin:16px 0 0;}
    .action-row .btn{
      background:linear-gradient(180deg,#6ea6b6,#3f7c8e);
      color:#fff; font-weight:900; box-shadow:0 6px 18px rgba(35,80,90,.18);
      border:0; padding:12px 14px; font-size:15px; border-radius:12px;
    }
    .action-row .btn:hover{filter:brightness(1.04);}
    .action-row .btn:active{transform:translateY(1px);}

    footer{margin:18px 4px 6px; text-align:center; color:#667; font-size:11px;}
    footer a{color:inherit; text-decoration:underline; text-underline-offset:2px;}

    /* モーダル */
    dialog{border:none; border-radius:14px; box-shadow:var(--shadow); padding:0; max-width:min(92vw, 720px);}
    dialog::backdrop{background:rgba(0,0,0,.25);}
    .dlg-body{padding:10px; background:#fff; border-radius:14px;}
    .dlg-head{display:flex; justify-content:space-between; align-items:center; padding:8px 12px 0;}
    .dlg-head h3{margin:0; font-size:16px;}
    .dlg-close{border:none; background:transparent; font-size:20px; cursor:pointer; line-height:1;}
    .dlg-img{display:block; width:100%; height:auto; border-radius:12px; margin:8px auto 12px;}

    /* 印刷（A4 1枚想定） */
    @page { size: A4 portrait; margin: 12mm; }
    @media print{
      body{background:#fff;}
      .action-row, .helper-btn{display:none !important;}
      .card{box-shadow:none; margin:8mm 0; padding:12mm 10mm;}
      .title{font-size:18px;}
      .amount{font-size:26px;}
      .kpi .chip-like{padding:6px 8px;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="ロゴ.jpg" alt="松本会計事務所ロゴ" class="logo" />
        <h1 class="title">標準保障額・保険料売上換算ツール</h1>
      </div>
      <div class="subtitle">標準保障額／必要保険料と限界利益率から、売上相当額・売上比率・必要販売数を算出します。</div>
    </header>

    <!-- カード1：標準保障額の換算 -->
    <section class="card" aria-label="標準保障額の換算">
      <h2>標準保障額の換算</h2>

      <!-- 1行目：左=標準保障額、右=限界利益率（スライダー長＋入力小を同一行） -->
      <div class="row-two">
        <div>
          <div class="label">標準保障額（円）</div>
          <div class="inline-actions">
            <div class="yen-input compact">
              <span class="prefix">¥</span>
              <input id="cov" class="money" type="text" inputmode="numeric" placeholder="例：5,000,000" autocomplete="off" />
            </div>
            <button class="helper-btn" id="openCovInfo" type="button">標準保障額の説明</button>
          </div>
        </div>

        <div>
          <div class="label">御社の限界利益率（％）</div>
          <div class="inline-actions nowrap">
            <input id="cmr" type="range" min="5" max="95" step="0.1" value="54.7" />
            <div class="pctbox"><input id="cmrInput" class="pct" type="text" inputmode="decimal" value="54.7" /><span class="unit">%</span></div>
          </div>
        </div>
      </div>

      <!-- 2行目：任意（売上・平均単価）を横並びで -->
      <div class="row-two" style="margin-top:10px;">
        <div>
          <div class="label">売上（円）</div>
          <div class="inline-actions">
            <div class="yen-input">
              <span class="prefix">¥</span>
              <input id="sales" class="money" type="text" inputmode="numeric" placeholder="例：120,000,000" autocomplete="off" />
            </div>
            <div class="chip-row" role="tablist" aria-label="売上の期間">
              <button class="chip" id="salesMonthly" type="button" data-type="month" aria-selected="false">月額</button>
              <button class="chip active" id="salesYearly" type="button" data-type="year" aria-selected="true">年額</button>
            </div>
          </div>
        </div>

        <div>
          <div class="label">平均単価（円）</div>
          <div class="yen-input">
            <span class="prefix">¥</span>
            <input id="avgPrice" class="money" type="text" inputmode="numeric" placeholder="例：10,000" autocomplete="off" />
          </div>
        </div>
      </div>

      <button id="calcCov" class="btn" type="button" style="margin-top:12px;">売上に換算</button>

      <div class="result" id="resCov" hidden>
        <div class="amount" id="salesCov"></div>
        <div class="statement" id="stmtCov"></div>
        <div class="kpi">
          <span class="chip-like" id="pctAnnualCov" hidden>年間売上の — %</span>
          <span class="chip-like" id="unitsCovChip" hidden>必要販売数：—</span>
          <span class="chip-like" id="formulaCovChip">計算式：標準保障額 ÷ (限界利益率 / 100)</span>
        </div>
      </div>
    </section>

    <!-- カード2：必要保険料の換算 -->
    <section class="card" aria-label="必要保険料の換算">
      <h2>必要保険料の換算</h2>

      <div class="label">必要保険料（円）</div>
      <div class="inline-actions">
        <div class="yen-input compact">
          <span class="prefix">¥</span>
          <input id="prem" class="money" type="text" inputmode="numeric" placeholder="例：12,000" autocomplete="off" />
        </div>
        <div class="chip-row" role="tablist" aria-label="保険料の期間">
          <button class="chip active" id="premMonthly" type="button" data-type="month" aria-selected="true">月額</button>
          <button class="chip" id="premYearly" type="button" data-type="year" aria-selected="false">年額</button>
        </div>
      </div>

      <button id="calcPrem" class="btn" type="button" style="margin-top:12px;">売上に換算</button>

      <div class="result" id="resPrem" hidden>
        <div class="amount" id="salesPrem"></div>
        <div class="statement" id="stmtPrem"></div>
        <div class="kpi">
          <span class="chip-like" id="pctSalesPrem" hidden>—</span>
          <span class="chip-like" id="unitsPremChip" hidden>必要販売数：—</span>
          <span class="chip-like" id="formulaPremChip">計算式：必要保険料 ÷ (限界利益率 / 100)</span>
        </div>
      </div>
    </section>

    <!-- 共通操作：3ボタン同一行（目立つ） -->
    <section class="action-row" aria-label="操作">
      <button id="copy" class="btn" type="button">コピー</button>
      <button id="reset" class="btn" type="button">リセット</button>
      <button id="print" class="btn" type="button">印刷</button>
    </section>

    <footer>
      Copyright (c) <span id="yyyy"></span>
      <a href="https://www.matsumoto-kaikei.or.jp/" target="_blank" rel="noopener">税理士法人松本会計事務所</a>
      All Rights Reserved. / r5
    </footer>
  </div>

  <!-- 標準保障額の説明モーダル -->
  <dialog id="covInfoDlg" aria-labelledby="covInfoTitle">
    <div class="dlg-body">
      <div class="dlg-head">
        <h3 id="covInfoTitle">標準保障額の説明</h3>
        <button class="dlg-close" id="closeCovInfo" aria-label="閉じる">×</button>
      </div>
      <img src="標準保障額.png" alt="標準保障額の説明図" class="dlg-img" />
    </div>
  </dialog>

  <script>
    const $ = s => document.querySelector(s);
    const fmtJPY   = n => n.toLocaleString('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0});
    const fmtPlain = n => n.toLocaleString('ja-JP',{maximumFractionDigits:0});
    const parsePct = t => { if(t==null) return NaN; const s=String(t).replace('%','').replace(',', '.').trim(); return Number(s); };
    const clamp    = (v,min,max)=>Math.max(min,Math.min(max,v));

    $('#yyyy').textContent = String(new Date().getFullYear());

    // 要素
    const covEl = $('#cov');
    const cmrR  = $('#cmr');
    const cmrI  = $('#cmrInput');

    const salesEl = $('#sales');
    const salesMonthly = $('#salesMonthly'), salesYearly = $('#salesYearly');
    const avgEl   = $('#avgPrice');

    const premEl  = $('#prem');
    const premMonthly = $('#premMonthly'), premYearly = $('#premYearly');

    const resCov = $('#resCov'), salesCovEl = $('#salesCov'), stmtCov = $('#stmtCov'),
          pctAnnualCov = $('#pctAnnualCov'), unitsCovChip = $('#unitsCovChip');

    const resPrem = $('#resPrem'), salesPremEl = $('#salesPrem'), stmtPrem = $('#stmtPrem'),
          pctSalesPrem = $('#pctSalesPrem'), unitsPremChip = $('#unitsPremChip');

    // CMR 永続化（デフォルト 54.7%）
    const STORAGE_KEY_CMR='cmrPct_r5', DEFAULT_CMR=54.7;
    function loadCmr(){ try{ const v=Number(localStorage.getItem(STORAGE_KEY_CMR)); if(!isNaN(v)) return clamp(v,+cmrR.min,+cmrR.max);}catch{} return DEFAULT_CMR; }
    function saveCmr(v){ try{ localStorage.setItem(STORAGE_KEY_CMR, Number(v).toFixed(1)); }catch{} }
    const initCmr=loadCmr(); cmrR.value=initCmr.toFixed(1); cmrI.value=initCmr.toFixed(1);
    cmrR.addEventListener('input', ()=>{ const v=+cmrR.value; if(document.activeElement!==cmrI){ cmrI.value=v.toFixed(1);} saveCmr(v); if(autoAny) autoRecalc(); });
    function commitCmrInput(){
      const v=parsePct(cmrI.value); if(isNaN(v)){ cmrI.value=(+cmrR.value).toFixed(1); return; }
      const c=clamp(v,+cmrR.min,+cmrR.max); cmrR.value=c.toFixed(1); cmrI.value=c.toFixed(1); saveCmr(c);
    }
    cmrI.addEventListener('input', ()=>{ const v=parsePct(cmrI.value); if(!isNaN(v)&&v>=+cmrR.min&&v<=+cmrR.max){ cmrR.value=v.toFixed(1);} if(autoAny) autoRecalc(); });
    cmrI.addEventListener('blur', commitCmrInput);

    // 金額リアルタイム・カンマ整形
    function normalizeDigits(str){
      if(!str) return '';
      str = str.replace(/[０-９]/g, s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0));
      const map={'⓪':'0','①':'1','②':'2','③':'3','④':'4','⑤':'5','⑥':'6','⑦':'7','⑧':'8','⑨':'9'};
      str = str.replace(/[⓪①②③④⑤⑥⑦⑧⑨]/g, s=>map[s]||s);
      return str.replace(/[^\d]/g,'');
    }
    function attachMoneyFormatter(input, onChange){
      input.addEventListener('input', (e)=>{
        const raw = normalizeDigits(e.target.value);
        if(raw===''){ e.target.value=''; onChange?.(); return; }
        e.target.value = Number(raw).toLocaleString('ja-JP'); onChange?.();
      });
      input.addEventListener('focus', (e)=>{
        const digits = e.target.value.replace(/[^\d]/g,''); if(digits) e.target.value = String(Number(digits));
      });
      input.addEventListener('blur', (e)=>{
        const digits = e.target.value.replace(/[^\d]/g,''); e.target.value = digits ? Number(digits).toLocaleString('ja-JP') : '';
      });
    }
    attachMoneyFormatter(covEl, ()=>{ if(autoCov) calcCoverage(); });
    attachMoneyFormatter(premEl, ()=>{ if(autoPrem) calcPremium(); });
    attachMoneyFormatter(salesEl, ()=>{ if(resCov.hidden && resPrem.hidden) return; updateOptionalMetrics(); });
    attachMoneyFormatter(avgEl,   ()=>{ if(resCov.hidden && resPrem.hidden) return; updateOptionalMetrics(); });

    const parseMoney = s => {
      if(s==null || s==='') return NaN;
      const digits = String(s).replace(/[^\d]/g,'');
      return digits ? Number(digits) : NaN;
    };

    // 期間チップ
    function activateChip(chosen, other){
      chosen.classList.add('active'); chosen.setAttribute('aria-selected','true');
      other.classList.remove('active'); other.setAttribute('aria-selected','false');
    }
    function updatePlaceholders(){
      // 売上
      if(salesYearly.classList.contains('active')) salesEl.placeholder = '例：120,000,000';
      else                                         salesEl.placeholder = '例：10,000,000';
      // 保険料
      if(premYearly.classList.contains('active'))  premEl.placeholder  = '例：144,000';
      else                                         premEl.placeholder  = '例：12,000';
    }
    salesMonthly.addEventListener('click', ()=>{
      activateChip(salesMonthly, salesYearly); updatePlaceholders();
      if(!resCov.hidden || !resPrem.hidden) updateOptionalMetrics();
    });
    salesYearly .addEventListener('click', ()=>{
      activateChip(salesYearly , salesMonthly); updatePlaceholders();
      if(!resCov.hidden || !resPrem.hidden) updateOptionalMetrics();
    });
    premMonthly .addEventListener('click', ()=>{
      activateChip(premMonthly , premYearly ); updatePlaceholders();
      if(autoPrem) calcPremium(); else updateOptionalMetrics();
    });
    premYearly  .addEventListener('click', ()=>{
      activateChip(premYearly  , premMonthly); updatePlaceholders();
      if(autoPrem) calcPremium(); else updateOptionalMetrics();
    });
    updatePlaceholders(); // 初期

    // 自動再計算のフラグ
    let autoCov=false, autoPrem=false;
    const autoAny = ()=> autoCov || autoPrem;
    function autoRecalc(){
      if(autoCov)  calcCoverage(false); // falseでスクロール抑制
      if(autoPrem) calcPremium(false);
    }

    // 任意項目の反映
    function updateOptionalMetrics(){
      const avg = parseMoney(avgEl.value);
      const salesVal = parseMoney(salesEl.value);
      const salesPeriod = salesYearly.classList.contains('active') ? 'year' : 'month';

      // 標準保障額カード
      if(!resCov.hidden && salesCovEl.textContent){
        if(salesVal>0){
          const annualSales = (salesPeriod==='year') ? salesVal : salesVal*12;
          const covVal = Number(String(salesCovEl.textContent).replace(/[^\d]/g,''));
          const pct = annualSales>0 ? (covVal/annualSales)*100 : NaN;
          if(!isNaN(pct)){ pctAnnualCov.textContent = `年間売上の ${pct.toFixed(1)}%`; pctAnnualCov.hidden = false; }
          else{ pctAnnualCov.hidden = true; }
        }else{
          pctAnnualCov.hidden = true;
        }
        if(avg>0){
          const covVal = Number(String(salesCovEl.textContent).replace(/[^\d]/g,''));
          unitsCovChip.textContent = `必要販売数：${(covVal/avg).toFixed(1)}`;
          unitsCovChip.hidden = false;
        }else{
          unitsCovChip.hidden = true;
        }
      }

      // 保険料カード
      if(!resPrem.hidden && salesPremEl.textContent){
        if(salesVal>0){
          const premVal = Number(String(salesPremEl.textContent).replace(/[^\d]/g,''));
          if(premMonthly.classList.contains('active')){
            const base = (salesPeriod==='month') ? salesVal : salesVal/12;
            pctSalesPrem.textContent = `月間売上の ${((premVal/base)*100).toFixed(1)}%`;
          }else{
            const base = (salesPeriod==='year') ? salesVal : salesVal*12;
            pctSalesPrem.textContent = `年間売上の ${((premVal/base)*100).toFixed(1)}%`;
          }
          pctSalesPrem.hidden = false;
        }else{
          pctSalesPrem.hidden = true;
        }
        if(avg>0){
          const premVal = Number(String(salesPremEl.textContent).replace(/[^\d]/g,''));
          unitsPremChip.textContent = `必要販売数：${(premVal/avg).toFixed(1)}`;
          unitsPremChip.hidden = false;
        }else{
          unitsPremChip.hidden = true;
        }
      }
    }

    // 標準保障額 計算
    function calcCoverage(scroll=true){
      commitCmrInput();
      const rate = parsePct(cmrI.value)/100;
      const cov  = parseMoney(covEl.value);

      if(!(rate>0)){ alert('限界利益率を正しく入力してください。'); cmrI.focus(); return; }
      if(!(cov>0)){ alert('標準保障額を入力してください。'); covEl.focus(); return; }

      const salesNeededCov = Math.ceil(cov / rate);
      resCov.hidden = false;
      salesCovEl.textContent = fmtJPY(salesNeededCov);
      // 文言（改行入り）
      stmtCov.innerHTML = `標準保障額 ${fmtJPY(cov)} は、御社の売上 ${fmtJPY(salesNeededCov)} に相当します。<br>保険事故発生後短期間で被保険者無しに上記の売上を上げることはできますか？`;

      updateOptionalMetrics();
      autoCov = true; // 以後はリアルタイム再計算
      if(scroll) resCov.scrollIntoView({behavior:'smooth', block:'center'});
    }

    // 保険料 計算
    function calcPremium(scroll=true){
      commitCmrInput();
      const rate = parsePct(cmrI.value)/100;
      const prem = parseMoney(premEl.value);
      const isMonth = premMonthly.classList.contains('active');

      if(!(rate>0)){ alert('限界利益率を正しく入力してください。'); cmrI.focus(); return; }
      if(!(prem>0)){ alert('必要保険料を入力してください。'); premEl.focus(); return; }

      const salesNeededPrem = Math.ceil(prem / rate);
      resPrem.hidden = false;

      salesPremEl.textContent = isMonth ? `${fmtJPY(salesNeededPrem)} / 月` : `${fmtJPY(salesNeededPrem)} / 年`;
      // 文言（（）無し・改行入り）
      stmtPrem.innerHTML = isMonth
        ? `必要保険料 ${fmtJPY(prem)} は、御社の月間売上 ${fmtJPY(salesNeededPrem)} に相当します。<br>この売上を追加で上げれば、必要保険料をカバーすることができ、将来の不安が解消できます。`
        : `必要保険料 ${fmtJPY(prem)} は、御社の年間売上 ${fmtJPY(salesNeededPrem)} に相当します。<br>この売上を追加で上げれば、必要保険料をカバーすることができ、将来の不安が解消できます。`;

      updateOptionalMetrics();
      autoPrem = true; // 以後はリアルタイム再計算
      if(scroll) resPrem.scrollIntoView({behavior:'smooth', block:'center'});
    }

    // イベント
    $('#calcCov').addEventListener('click', ()=> calcCoverage(true));
    $('#calcPrem').addEventListener('click', ()=> calcPremium(true));

    // クリップボード
    $('#copy').addEventListener('click', async ()=>{
      const cmrTxt = `${(+parsePct(cmrI.value)).toFixed(1)}%`;
      const lines = [];
      if(!resCov.hidden){
        lines.push(`[標準保障額] ${salesCovEl.textContent}（CMR ${cmrTxt}）`);
        lines.push(stmtCov.textContent);
        if(!pctAnnualCov.hidden) lines.push(`・${pctAnnualCov.textContent}`);
        if(!unitsCovChip.hidden) lines.push(`・${unitsCovChip.textContent}`);
      }
      if(!resPrem.hidden){
        lines.push(`[必要保険料] ${salesPremEl.textContent}（CMR ${cmrTxt}）`);
        lines.push(stmtPrem.textContent);
        if(!pctSalesPrem.hidden) lines.push(`・${pctSalesPrem.textContent}`);
        if(!unitsPremChip.hidden) lines.push(`・${unitsPremChip.textContent}`);
      }
      const salesV = parseMoney(salesEl.value), avgV = parseMoney(avgEl.value);
      if(salesV>0){ const p = salesYearly.classList.contains('active')?'年額':'月額'; lines.push(`売上(${p}): ¥${fmtPlain(salesV)}`); }
      if(avgV>0){ lines.push(`平均単価: ¥${fmtPlain(avgV)}`); }
      const text = lines.join('\n');

      try{
        if(navigator.clipboard?.writeText){ await navigator.clipboard.writeText(text); alert('結果をコピーしました。'); }
        else{
          const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('結果をコピーしました。');
        }
      }catch{ alert('コピーに失敗しました。'); }
    });

    // リセット
    $('#reset').addEventListener('click', ()=>{
      [covEl, salesEl, avgEl, premEl].forEach(el=> el.value='');
      activateChip(salesYearly, salesMonthly);
      activateChip(premMonthly, premYearly);
      updatePlaceholders();
      const c=loadCmr(); cmrR.value=c.toFixed(1); cmrI.value=c.toFixed(1);
      resCov.hidden=true; resPrem.hidden=true;
      pctAnnualCov.hidden=true; pctSalesPrem.hidden=true;
      unitsCovChip.hidden=true; unitsPremChip.hidden=true;
      autoCov=false; autoPrem=false;
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // 印刷
    $('#print').addEventListener('click', ()=>{ if(resCov.hidden && resPrem.hidden){ return; } window.print(); });

    // 説明モーダル
    const dlg = $('#covInfoDlg');
    $('#openCovInfo').addEventListener('click', ()=> dlg.showModal());
    $('#closeCovInfo').addEventListener('click', ()=> dlg.close());
    dlg.addEventListener('click', (e)=>{ if(e.target===dlg) dlg.close(); });
  </script>
</body>
</html>
